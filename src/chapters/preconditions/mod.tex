\chapter{Backward Abstract Hoare Logic}

When defining the semantics for $\lang$, we implicitly assumed that the
abstract inductive semantics is forward by giving the definition $\asem{C_1
\fcmp C_2} \defeq \asem{C_2} \circ \asem{C_1}$. However, except for the rule
($\fcmp$), we never explicitly used this fact. We can reuse the theory of
Abstract Hoare logic to construct a slight variation called Backward Abstract
Hoare logic, which describes Hoare logics where the semantics is defined
backward.

\section{Framework}

\subsection{Backward abstract inductive semantics}

To define the backward version of Abstract Hoare logic, we first need a
backward version of the abstract inductive semantics:

\begin{definition}[Backward abstract inductive semantics]
  Given a complete lattice $A$ and a family of monotone functions $\bsem{\cdot}^A :
  BCmd \to A \to A$, the abstract inductive semantics is defined as
  follows:

  \begin{align*}
      \asemback{\cdot}         & \;\;:\; \lang \to A \to A \\
      \asemback{\sskip}        &\defeq id \\
      \asemback{b}             &\defeq \bsem{b}^A \\
      \asemback{C_1 \fcmp C_2} &\defeq \asemback{C_1} \circ \asemback{C_2} \\
      \asemback{C_1 + C_2}     &\defeq \lambda P . \asemback{C_1} P \join_A \asemback{C_2} P \\
      \asemback{C^\fix}        &\defeq \lambda P . \lfp(\lambda P'. P \join_A \asemback{C} P')
  \end{align*}
\end{definition}

The only difference from the abstract inductive semantics provided in
definition \ref{def:abstract-inductive-semantics} is the case for $C_1 \fcmp
C_2$.

We can prove that the backward abstract inductive semantics is still monotone.

\begin{theorem}[Monotonicity]
  \label{thm:asem-mono-back} 
  For all $C \in \lang$, $\asemback{C}$ is well-defined and monotone.
\end{theorem}

\begin{proof}
  We modify the inductive case of the proof of theorem \ref{thm:asem-mono} by
  providing only the case for $\asemback{C_1 \fcmp C_2}$ as all the other cases
  are identical.

  \begin{itemize}
    \item $C_1 \fcmp C_2$:

      By inductive hypothesis, $\asemback{C_2}$ is monotone, hence
      $\asemback{C_2}(P) \leq_A \asemback{C_2}(Q)$.

      \begin{align*}
        \asemback{C_1 \fcmp C_2}(P) 
          &= \asemback{C_1}(\asemback{C_2}(P))
          &\text{[By definition of $\asemback{C_1 \fcmp C_2}$]}\\
          &\leq_A \asemback{C_1}(\asemback{C_2}(Q))
          &\text{[By inductive hypothesis on $\asemback{C_1}$]} \\
      \end{align*}
  \end{itemize}
\end{proof}

\subsection{Backward Abstract Hoare Logic}

Now we can provide the definition for the backward abstract Hoare triples,
which is the same as for abstract Hoare triples, only with the backward
abstract inductive semantics instead of the usual abstract inductive semantics.

\begin{definition}[Backward Abstract Hoare triple]
  \label{def:baht}
  Given an abstract inductive semantics $\asemback{\cdot}$ on the complete
  lattice $A$, the abstract Hoare triple written $\atripleback{P}{C}{Q}$ is
  valid if and only if $\asemback{C}(P) \leq_A Q$.

  $$\models \atripleback{P}{C}{Q} \iff \asemback{C}(P) \leq_A Q$$
\end{definition}

Clearly, the proof system only needs to be modified to accommodate the new
semantics for program composition, and all the other rules remain the same.

\begin{definition}[Backward Abstract Hoare rules]$\;$\\
  We only provide the rule for program composition; all the other rules are
  identical to those provided in definition \ref{def:ahtrules}.

  % Rule for sequential composition
  \begin{prooftree}
    \AxiomC{$\vdash \atripleback{P}{C_2}{Q}$}
    \AxiomC{$\vdash \atripleback{Q}{C_1}{R}$}
    \RightLabel{$(\mathbb{\fcmp})$}
    \BinaryInfC{$\vdash \atripleback{P}{C_1 \fcmp C_2}{R}$}
  \end{prooftree}
\end{definition}

The rule can be read as: If executing $C_2$ from state $P$ leads to state $Q$,
and executing $C_1$ from state $Q$ leads to state $R$, then executing $C_2$
followed by $C_1$ from state $P$ leads to state $R$. 

We can prove again that the proof system is still sound and complete.

\begin{theorem}[Soundness]
  \label{thm:atriple-sound-back}
  $$\vdash \atripleback{P}{C}{Q} \implies \models \atripleback{P}{C}{Q}$$
\end{theorem}

\begin{proof}
  We modify the inductive case of the proof of theorem \ref{thm:atriple-sound}
  by providing only the case for rule $(\fcmp)$ as all the other cases are
  identical.

  \begin{itemize}
      \item $(\fcmp)$: Then the last step in the derivation was:
        \begin{prooftree}
          \AxiomC{$\vdash \atripleback{P}{C_2}{Q}$}
          \AxiomC{$\vdash \atripleback{Q}{C_1}{R}$}
          \RightLabel{$(\mathbb{\fcmp})$}
          \BinaryInfC{$\vdash \atripleback{P}{C_1 \fcmp C_2}{R}$}
        \end{prooftree}
          
        By inductive hypothesis:
        $\asemback{C_2}(P) \leq_A Q$ and
        $\asemback{C_1}(Q) \leq_A R$.

        The triple is valid since:
        \begin{align*}
          \asemback{C_1 \fcmp C_2}(P)
            &= \asemback{C_1}(\asemback{C_2}(P))
            &\text{[By definition of $\asemback{\cdot}$]} \\
            &\leq_A \asemback{C_1}(Q)
            &\text{[By monotonicity of $\asemback{\cdot}$]} \\
            &\leq_A R
        \end{align*}
  \end{itemize}
\end{proof}

\begin{theorem}[Relative $\asemback{\cdot}$-completeness]
  \label{thm:post-completeness-back}
  $$\vdash \atripleback{P}{C}{\asemback{C}(P)}$$
\end{theorem}

\begin{proof}
  We modify the inductive case of the proof of theorem
  \ref{thm:post-completeness} by providing only the case for $C_1 \fcmp C_2$ as
  all the other cases are identical.

  \begin{itemize}
      \item $C_1 \fcmp C_2$:
        By definition $\asemback{C_1 \fcmp C_2}(P) = \asemback{C_1}(\asemback{C_2}(P))$

        \begin{prooftree}
          \AxiomC{(Inductive hypothesis)}
          \noLine
          \UnaryInfC{$\vdash \atripleback{P}{C_2}{\asemback{C_2}(P)}$}
          \AxiomC{(Inductive hypothesis)}
          \noLine
          \UnaryInfC{$\vdash \atripleback{\asemback{C_2}(P)}{C_1}{\asemback{C_1}(\asemback{C_2}(P))}$}
          \RightLabel{($\fcmp$)}
          \BinaryInfC{$\vdash \atripleback{P}{C_1 \fcmp C_2}{\asemback{C_1 \fcmp C_2}(P)}$}
        \end{prooftree}
  \end{itemize}
\end{proof}

\begin{theorem}[Relative completeness]
  $$\models \atripleback{P}{C}{C} \implies \vdash \atripleback{P}{C}{Q}$$
\end{theorem}
\begin{proof}
  By definition of $\models \atripleback{P}{C}{Q} \iff Q \geq_A \asemback{C}(P)$

  \begin{prooftree}
    \AxiomC{$P \leq_A P$}
    \AxiomC{(By Theorem \ref{thm:post-completeness-back})}
    \noLine
    \UnaryInfC{$\vdash \atripleback{P}{C}{\asemback{C}(P)}$}
    \AxiomC{$Q \geq_A \asemback{C}(P)$}
    \RightLabel{$(\leq)$}
    \TrinaryInfC{$\vdash \atripleback{P}{C}{Q}$}
  \end{prooftree}
\end{proof}

\section{Instantiations}

\subsection{Partial Incorrectness, Again}

An abstract inductive semantics induces automatically a backward abstract
inductive semantics where the semantics of the basic commands is inverted:

\begin{definition}[Reverse Abstract Inductive Semantics]
  Given an abstract inductive semantics defined on some complete lattice $A$
  with basic command semantics $\bsem{\cdot}^A$, we can define the reverse
  backward abstract inductive semantics as the backward inductive semantics
  instantiated on the complete lattice $A$ and basic command semantics
  $(\bsem{\cdot}^A)^{-1}$.
\end{definition}

Hence, the reverse abstract inductive semantics can be expressed as:
\begin{align*}
  \asemback{\sskip}        &= id \\
  \asemback{b}             &= (\bsem{b}^A)^{-1} \\
  \asemback{C_1 \fcmp C_2} &= \asemback{C_1} \circ \asemback{C_2} \\
  \asemback{C_1 + C_2}     &= \lambda P . \asemback{C_1} P \join_A \asemback{C_2} P \\
  \asemback{C^\fix}        &= \lambda P . \lfp(\lambda P'. P \join_A \asemback{C} P')
\end{align*}

Following the intuition that the abstract inductive semantics is some abstract
version of the strongest postcondition, what interpretation can we give for the
reverse abstract inductive semantics? The construction corresponds to the
abstract version of the weakest precondition. In fact, when the dual reverse
inductive semantics is obtained from the abstract inductive semantics on
$\pow{\states}$ (the strongest postcondition), the reverse semantics becomes
the weakest precondition.

Hence, from the validity of the triples: $$\models
\atripleback[\pow{\states}]{Q}{C}{P} \iff \asemback[\pow{\states}]{C}(Q)
\subseteq P \iff wp(C, Q) \subseteq P$$

This program logic is introduced in \cite{Ascari24} under the name of NC, and
the program logic is actually equivalent to the one in section
\ref{chp:partial-incorrectness}.

\subsection{Hoare Logic, Again}

Following what we did in section \ref{chp:partial-incorrectness}, we can first
obtain the reverse semantics but then also obtain the dual of the reverse
semantics. It can be expressed as: 
\begin{align*}
  \asemback[A^{op}]{\sskip}        &= id \\
  \asemback[A^{op}]{b}             &= (\bsem{b}^A)^{-1} \\
  \asemback[A^{op}]{C_1 \fcmp C_2} &= \asemback{C_1} \circ \asemback{C_2} \\
  \asemback[A^{op}]{C_1 + C_2}     &= \lambda P . \asemback[A^{op}]{C_1} P \meet_A \asemback[A^{op}]{C_2} P \\
  \asemback[A^{op}]{C^\fix}        &= \lambda P . \gfp_A(\lambda P'. P \meet_A \asemback[A^{op}]{C} P')
\end{align*}

Following the intuition that the abstract inductive semantics is some abstract
version of the strongest postcondition, what interpretation can we give for the
dual reverse abstract inductive semantics? The construction corresponds to the
reverse inductive semantics is obtained from the abstract inductive semantics
abstract version of the weakest liberal precondition. In fact, when the dual
on $\pow{\states}$ (the strongest postcondition), the reverse semantics becomes
the weakest liberal precondition.

Hence, from the validity of the triples:
$$\models \atripleback[\pow{\states}^{op}]{Q}{C}{P} \iff
\asemback[\pow{\states}]{C}(Q) \supseteq P \iff wlp(C, Q) \supseteq P$$

But also $wlp(C, Q) \supseteq P \iff \sem{C}(P) \subseteq Q$, hence it is
equivalent to Hoare logic.

